<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>手語辨識專題</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; media-src *;">
  <style>
    body { margin:0;
          font-family: Arial,
              sans-serif; 
          background:#f0f0f0; }
    video { width:100%; 
           max-width:640px;
           border:2px solid #000; 
           border-radius:10px; }
    #result-text { font-size:22px; 
                  color:#2c3e50; 
                  margin-top:15px; }
    button { margin-top:10px; 
            padding:10px 20px;
            background:#4CAF50; color:#fff; 
            border:none; border-radius:6px; 
            cursor:pointer; }
    button:hover { background:#45a049; }
    #search-box { margin-top:20px; }
    #search-input { padding:10px; font-size:16px; border:1px solid #ccc; border-radius:5px; width:100%; max-width:400px; }
  </style>
</head>
<body>

  <h1 style="text-align:center;">手語辨識專題</h1>

  <button id="login-button" style="position:absolute; top:20px; right:20px;">登入系統</button>
  <div id="user-info" style="position:absolute; top:20px; right:140px; font-weight:bold;"></div>

  <!-- 登入後畫面 -->
  <div id="auth-section" style="display:none; text-align:center; margin-top:80px;">
    <video id="camera" autoplay playsinline></video>
    <button id="toggle-camera">關閉攝影機</button>
    <p id="result-text">模型載入中...</p>

    <div id="search-box">
      <input id="search-input" type="text" placeholder="搜尋手語..." list="suggestions">
      <datalist id="suggestions"></datalist>
      <button onclick="search()">搜尋</button>
      <div>
        <video id="sign-video" controls style="max-width:400px;"></video>
      </div>
      <p id="search-result"></p>
    </div>
  </div>

  <!-- 登入前畫面 -->
  <div id="login-section" style="text-align:center; margin-top:150px;">
    <h2>請先登入以使用手語辨識功能</h2>
    <button onclick="window.location.href='login.html'">立即登入</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <!-- ONNX Runtime -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>
    // 🔹 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyCiB7v1mdKuPMIB3SUHPpmriSXmAsQ5G3M",
      authDomain: "hand-sign-project.firebaseapp.com",
      projectId: "hand-sign-project",
      storageBucket: "hand-sign-project.firebasestorage.app",
      messagingSenderId: "338082830115",
      appId: "1:338082830115:web:95ca6cd329dc49b1191e96"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 🔹 DOM 元素
    const loginBtn = document.getElementById("login-button");
    const userInfo = document.getElementById("user-info");
    const authSection = document.getElementById("auth-section");
    const loginSection = document.getElementById("login-section");

    // 🔹 登入狀態管理
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        loginBtn.textContent = "登出";
        loginBtn.onclick = () => auth.signOut().then(() => location.reload());
        userInfo.textContent = `歡迎，${user.email}`;
        authSection.style.display = "block";
        loginSection.style.display = "none";
        startCamera();
        initModel();  // 🚀 登入後啟動模型
        loadSuggestions();
      } else {
        loginBtn.textContent = "登入系統";
        loginBtn.onclick = () => window.location.href = "login.html";
        authSection.style.display = "none";
        loginSection.style.display = "block";
      }
    });

    // 🔹 攝影機控制
    let stream, cameraOn = true;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('camera').srcObject = stream;
      } catch (e) {
        alert("無法開啟攝影機：" + e.message);
      }
    }

    document.getElementById('toggle-camera').onclick = async () => {
      if (cameraOn) {
        stream.getTracks().forEach(t => t.stop());
        document.getElementById('camera').srcObject = null;
        document.getElementById('toggle-camera').textContent = "開啟攝影機";
      } else {
        await startCamera();
        document.getElementById('toggle-camera').textContent = "關閉攝影機";
      }
      cameraOn = !cameraOn;
    };

    // 🔹 YOLO 模型載入
    let session, labels = {};

    async function initModel() {
      document.getElementById('result-text').textContent = "🔄 模型載入中...";
      try {
        // 讀取 YAML 名稱
        const yamlText = await fetch("models/Time and application.yaml").then(r => r.text());
        const matches = [...yamlText.matchAll(/(\d+):\s*['"]?([\u4e00-\u9fa5A-Za-z0-9_]+)['"]?/g)];
        matches.forEach(([_, id, name]) => labels[id] = name);

        // 載入 ONNX 模型
        session = await ort.InferenceSession.create("models/best_web.onnx");
        document.getElementById('result-text').textContent = "✅ 模型載入成功，準備辨識...";
        detectLoop();
      } catch (e) {
        document.getElementById('result-text').textContent = "❌ 模型載入失敗：" + e.message;
      }
    }

    // 🔹 實時辨識
    async function detectLoop() {
      const video = document.getElementById('camera');
      const resultText = document.getElementById('result-text');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      async function frame() {
        if (session && cameraOn) {
          canvas.width = 320; canvas.height = 320;
          ctx.drawImage(video, 0, 0, 320, 320);
          const imgData = ctx.getImageData(0, 0, 320, 320);
          const input = new ort.Tensor("float32",
            new Float32Array(imgData.data.map(v => v/255)).filter((_, i) => i % 4 !== 3),
            [1, 3, 320, 320]
          );

          try {
            const output = await session.run({ images: input });
            const out = output[Object.keys(output)[0]];
            const maxIdx = out.data.indexOf(Math.max(...out.data));
            const classId = Math.floor(maxIdx % Object.keys(labels).length);
            resultText.textContent = "偵測結果：" + (labels[classId] || "未知");
          } catch (e) {
            resultText.textContent = "推論錯誤：" + e.message;
          }
        }
        requestAnimationFrame(frame);
      }
      frame();
    }

    // 🔹 Firestore 搜尋
    function search() {
      const query = document.getElementById('search-input').value.trim();
      const result = document.getElementById('search-result');
      if (!query) return result.textContent = "請輸入搜尋詞";

      db.collection("sign").where("chinese", "==", query).get().then(snap => {
        if (snap.empty) result.textContent = `找不到「${query}」`;
        else snap.forEach(doc => {
          const d = doc.data();
          result.textContent = `單字：${d.chinese}　英文：${d.english}`;
          if (d.videoUrl) document.getElementById('sign-video').src = d.videoUrl;
        });
      });
    }

    // 🔹 自動建議
    function loadSuggestions() {
      const datalist = document.getElementById('suggestions');
      db.collection("sign").get().then(snap => {
        snap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.data().chinese;
          datalist.appendChild(opt);
        });
      });
    }
  </script>
</body>
</html>
