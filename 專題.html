<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>æ‰‹èªè¾¨è­˜å°ˆé¡Œ</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; media-src *;">
  <style>
    body { margin:0;
          font-family: Arial,
              sans-serif; 
          background:#f0f0f0; }
    video { width:100%; 
           max-width:640px;
           border:2px solid #000; 
           border-radius:10px; }
    #result-text { font-size:22px; 
                  color:#2c3e50; 
                  margin-top:15px; }
    button { margin-top:10px; 
            padding:10px 20px;
            background:#4CAF50; color:#fff; 
            border:none; border-radius:6px; 
            cursor:pointer; }
    button:hover { background:#45a049; }
    #search-box { margin-top:20px; }
    #search-input { padding:10px; font-size:16px; border:1px solid #ccc; border-radius:5px; width:100%; max-width:400px; }
  </style>
</head>
<body>

  <h1 style="text-align:center;">æ‰‹èªè¾¨è­˜å°ˆé¡Œ</h1>

  <button id="login-button" style="position:absolute; top:20px; right:20px;">ç™»å…¥ç³»çµ±</button>
  <div id="user-info" style="position:absolute; top:20px; right:140px; font-weight:bold;"></div>

  <!-- ç™»å…¥å¾Œç•«é¢ -->
  <div id="auth-section" style="display:none; text-align:center; margin-top:80px;">
    <video id="camera" autoplay playsinline></video>
    <button id="toggle-camera">é—œé–‰æ”å½±æ©Ÿ</button>
    <p id="result-text">æ¨¡å‹è¼‰å…¥ä¸­...</p>

    <div id="search-box">
      <input id="search-input" type="text" placeholder="æœå°‹æ‰‹èª..." list="suggestions">
      <datalist id="suggestions"></datalist>
      <button onclick="search()">æœå°‹</button>
      <div>
        <video id="sign-video" controls style="max-width:400px;"></video>
      </div>
      <p id="search-result"></p>
    </div>
  </div>

  <!-- ç™»å…¥å‰ç•«é¢ -->
  <div id="login-section" style="text-align:center; margin-top:150px;">
    <h2>è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨æ‰‹èªè¾¨è­˜åŠŸèƒ½</h2>
    <button onclick="window.location.href='login.html'">ç«‹å³ç™»å…¥</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

  <!-- ONNX Runtime -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>
    // ğŸ”¹ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCiB7v1mdKuPMIB3SUHPpmriSXmAsQ5G3M",
      authDomain: "hand-sign-project.firebaseapp.com",
      projectId: "hand-sign-project",
      storageBucket: "hand-sign-project.firebasestorage.app",
      messagingSenderId: "338082830115",
      appId: "1:338082830115:web:95ca6cd329dc49b1191e96"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ğŸ”¹ DOM å…ƒç´ 
    const loginBtn = document.getElementById("login-button");
    const userInfo = document.getElementById("user-info");
    const authSection = document.getElementById("auth-section");
    const loginSection = document.getElementById("login-section");

    // ğŸ”¹ ç™»å…¥ç‹€æ…‹ç®¡ç†
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        loginBtn.textContent = "ç™»å‡º";
        loginBtn.onclick = () => auth.signOut().then(() => location.reload());
        userInfo.textContent = `æ­¡è¿ï¼Œ${user.email}`;
        authSection.style.display = "block";
        loginSection.style.display = "none";
        startCamera();
        initModel();  // ğŸš€ ç™»å…¥å¾Œå•Ÿå‹•æ¨¡å‹
        loadSuggestions();
      } else {
        loginBtn.textContent = "ç™»å…¥ç³»çµ±";
        loginBtn.onclick = () => window.location.href = "login.html";
        authSection.style.display = "none";
        loginSection.style.display = "block";
      }
    });

    // ğŸ”¹ æ”å½±æ©Ÿæ§åˆ¶
    let stream, cameraOn = true;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('camera').srcObject = stream;
      } catch (e) {
        alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼š" + e.message);
      }
    }

    document.getElementById('toggle-camera').onclick = async () => {
      if (cameraOn) {
        stream.getTracks().forEach(t => t.stop());
        document.getElementById('camera').srcObject = null;
        document.getElementById('toggle-camera').textContent = "é–‹å•Ÿæ”å½±æ©Ÿ";
      } else {
        await startCamera();
        document.getElementById('toggle-camera').textContent = "é—œé–‰æ”å½±æ©Ÿ";
      }
      cameraOn = !cameraOn;
    };

    // ğŸ”¹ YOLO æ¨¡å‹è¼‰å…¥
    let session, labels = {};

    async function initModel() {
      document.getElementById('result-text').textContent = "ğŸ”„ æ¨¡å‹è¼‰å…¥ä¸­...";
      try {
        // è®€å– YAML åç¨±
        const yamlText = await fetch("models/Time and application.yaml").then(r => r.text());
        const matches = [...yamlText.matchAll(/(\d+):\s*['"]?([\u4e00-\u9fa5A-Za-z0-9_]+)['"]?/g)];
        matches.forEach(([_, id, name]) => labels[id] = name);

        // è¼‰å…¥ ONNX æ¨¡å‹
        session = await ort.InferenceSession.create("models/best_web.onnx");
        document.getElementById('result-text').textContent = "âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸï¼Œæº–å‚™è¾¨è­˜...";
        detectLoop();
      } catch (e) {
        document.getElementById('result-text').textContent = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š" + e.message;
      }
    }

    // ğŸ”¹ å¯¦æ™‚è¾¨è­˜
    async function detectLoop() {
      const video = document.getElementById('camera');
      const resultText = document.getElementById('result-text');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      async function frame() {
        if (session && cameraOn) {
          canvas.width = 320; canvas.height = 320;
          ctx.drawImage(video, 0, 0, 320, 320);
          const imgData = ctx.getImageData(0, 0, 320, 320);
          const input = new ort.Tensor("float32",
            new Float32Array(imgData.data.map(v => v/255)).filter((_, i) => i % 4 !== 3),
            [1, 3, 320, 320]
          );

          try {
            const output = await session.run({ images: input });
            const out = output[Object.keys(output)[0]];
            const maxIdx = out.data.indexOf(Math.max(...out.data));
            const classId = Math.floor(maxIdx % Object.keys(labels).length);
            resultText.textContent = "åµæ¸¬çµæœï¼š" + (labels[classId] || "æœªçŸ¥");
          } catch (e) {
            resultText.textContent = "æ¨è«–éŒ¯èª¤ï¼š" + e.message;
          }
        }
        requestAnimationFrame(frame);
      }
      frame();
    }

    // ğŸ”¹ Firestore æœå°‹
    function search() {
      const query = document.getElementById('search-input').value.trim();
      const result = document.getElementById('search-result');
      if (!query) return result.textContent = "è«‹è¼¸å…¥æœå°‹è©";

      db.collection("sign").where("chinese", "==", query).get().then(snap => {
        if (snap.empty) result.textContent = `æ‰¾ä¸åˆ°ã€Œ${query}ã€`;
        else snap.forEach(doc => {
          const d = doc.data();
          result.textContent = `å–®å­—ï¼š${d.chinese}ã€€è‹±æ–‡ï¼š${d.english}`;
          if (d.videoUrl) document.getElementById('sign-video').src = d.videoUrl;
        });
      });
    }

    // ğŸ”¹ è‡ªå‹•å»ºè­°
    function loadSuggestions() {
      const datalist = document.getElementById('suggestions');
      db.collection("sign").get().then(snap => {
        snap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.data().chinese;
          datalist.appendChild(opt);
        });
      });
    }
  </script>
</body>
</html>
